<!-- templates/ocr_app/person_management.html -->
{% extends 'ocr_app/base.html' %}
{% load permission_tags %}

{% block page_title %}Ù…Ø¯ÛŒØ±ÛŒØª Ø§ÙØ±Ø§Ø¯ Ùˆ Ù¾Ø±ÙˆÙ†Ø¯Ù‡â€ŒÙ‡Ø§{% endblock %}

{% block content %}
<div class="header">
    <h1>Ù…Ø¯ÛŒØ±ÛŒØª Ø§ÙØ±Ø§Ø¯</h1>
<!-- Ù…ÙˆÙ‚ØªØ§Ù‹ Ø§ÛŒÙ† Ø±Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù† ØªØ§ Ø¨Ø¨ÛŒÙ†ÛŒ ÙÛŒÙ„ØªØ± Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡ -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        {% if user.is_authenticated and user|has_perm:'person_create' %}
        <button class="btn btn-primary" onclick="showCreatePersonModal()">
            â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯
        </button>
        {% else %}
        <button class="btn btn-primary" disabled style="background: #95a5a6; cursor: not-allowed;">
            â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯
        </button>
        {% endif %}
        <div style="display: flex; align-items: center;">
            <input type="text" id="searchInput" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ..."
                   style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px; width: 300px; font-size: 14px;">

            {% if user.is_authenticated and user|has_perm:'search_persons' %}
            <button class="btn btn-success" onclick="searchPersons()">
                ğŸ” Ø¬Ø³ØªØ¬Ùˆ
            </button>
            {% else %}
            <button class="btn btn-success" disabled style="background: #95a5a6; cursor: not-allowed;">
                ğŸ” Ø¬Ø³ØªØ¬Ùˆ
            </button>
            {% endif %}
            <button class="btn" onclick="clearSearch()" style="background: #95a5a6; color: white; margin-left: 10px;">
                Ù¾Ø§Ú© Ú©Ø±Ø¯Ù†
            </button>
        </div>
    </div>
</div>

<!-- Ø¨Ø®Ø´ Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ù†ØªØ§ÛŒØ¬ -->
<div id="searchSection">
    <!-- Ù¾ÛŒØ§Ù… Ø®ÙˆØ´Ø§Ù…Ø¯Ú¯ÙˆÛŒÛŒ -->
    <div id="welcomeMessage"
         style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px; margin-bottom: 20px;">
        <div style="font-size: 72px; margin-bottom: 20px;">ğŸ”</div>
        <h2 style="color: #2c3e50; margin-bottom: 15px;">Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø³Ù†Ø§Ø¯ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6;">
            Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§ÙØ±Ø§Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ú©Ø§Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨Ø§Ù„Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.<br>
            Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ ÛŒØ§ Ú©Ø¯ Ù…Ù„ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.
        </p>
    </div>

    <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ -->
    <div id="searchResults" style="display: none;">
        <h3 style="color: #2c3e50; margin-bottom: 20px;">Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h3>
        <div class="persons-grid" id="personsGrid"
             style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <!-- Ù†ØªØ§ÛŒØ¬ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
        </div>

        <div id="noResults" style="display: none; text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ˜•</div>
            <h4 style="color: #7f8c8d; margin-bottom: 10px;">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
            <p style="color: #95a5a6;">Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬ÙˆÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.</p>
        </div>
    </div>
</div>

<!-- Modal Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯ -->
<div id="createPersonModal"
     style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; overflow-y: auto;">
    <div style="background: white; width: 500px; margin: 50px auto; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative;">
        <h3 style="color: #2c3e50; margin-bottom: 20px;">Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯</h3>
        <form id="createPersonForm">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">Ù†Ø§Ù…:</label>
                <input type="text" name="first_name" placeholder="Ù†Ø§Ù…" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ:</label>
                <input type="text" name="last_name" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">Ú©Ø¯ Ù…Ù„ÛŒ:</label>
                <input type="text" name="national_id" placeholder="Ú©Ø¯ Ù…Ù„ÛŒ" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø³Ù†Ù„ÛŒ:</label>
                <input type="text" name="employee_id" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø³Ù†Ù„ÛŒ"
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">Ø´Ø±Ø­ Ù¾Ø±ÙˆÙ†Ø¯Ù‡:</label>
                <textarea name="case_description" placeholder="Ø´Ø±Ø­ Ù¾Ø±ÙˆÙ†Ø¯Ù‡"
                          style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px; position: sticky; bottom: 0; background: white; padding-top: 15px; border-top: 1px solid #eee;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡</button>
                <button type="button" class="btn" onclick="hideCreatePersonModal()"
                        style="flex: 1; background: #95a5a6; color: white;">âŒ Ù„ØºÙˆ
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Modal
    function showCreatePersonModal() {
        document.getElementById('createPersonModal').style.display = 'block';
    }

    function hideCreatePersonModal() {
        document.getElementById('createPersonModal').style.display = 'none';
    }

    // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙØ±Ø§Ø¯
    function searchPersons() {
        const query = document.getElementById('searchInput').value.trim();

        if (!query) {
            alert('Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }

        // Ù†Ù…Ø§ÛŒØ´ loading
        document.getElementById('welcomeMessage').style.display = 'none';
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('personsGrid').innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p>Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬Ùˆ...</p></div>';

        // Ø¬Ø³ØªØ¬ÙˆÛŒ AJAX
        fetch(`/search/?q=${encodeURIComponent(query)}&type=people`)
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const results = tempDiv.querySelector('.persons-grid') || tempDiv.querySelector('#personsGrid');

                if (results && results.innerHTML.trim()) {
                    document.getElementById('personsGrid').innerHTML = results.innerHTML;
                    document.getElementById('noResults').style.display = 'none';
                } else {
                    document.getElementById('personsGrid').innerHTML = '';
                    document.getElementById('noResults').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('personsGrid').innerHTML = '';
                document.getElementById('noResults').style.display = 'block';
            });
    }

    // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø§ Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPersons();
        }
    });

    // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø³ØªØ¬Ùˆ
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('welcomeMessage').style.display = 'block';
        document.getElementById('searchResults').style.display = 'none';
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ ÙØ±Ø¯
    document.getElementById('createPersonForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/create-person/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('ÙØ±Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                hideCreatePersonModal();
                if (document.getElementById('searchResults').style.display === 'block') {
                    searchPersons();
                }
            } else {
                alert('Ø®Ø·Ø§: ' + result.error);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        }
    };

    // Ø¨Ø³ØªÙ† Modal Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¢Ù†
    document.getElementById('createPersonModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideCreatePersonModal();
        }
    });

    // Ø§Ú¯Ø± Ø¯Ø± URL Ù¾Ø§Ø±Ø§Ù…ØªØ± Ø¬Ø³ØªØ¬Ùˆ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ØŒ Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    if (searchQuery) {
        document.getElementById('searchInput').value = searchQuery;
        setTimeout(() => searchPersons(), 100);
    }
</script>
{% endblock %}