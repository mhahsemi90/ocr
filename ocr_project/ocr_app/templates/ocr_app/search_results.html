<!-- templates/ocr_app/search_results.html -->
{% extends 'ocr_app/base.html' %}
{% load permission_tags %}

{% block page_title %}Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ{% endblock %}

{% block content %}
<div class="header">
    <h1>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h1>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <button class="btn btn-primary" onclick="location.href='{% url 'search_documents' %}'">
            ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯
        </button>

        <div style="color: #7f8c8d;">
            <strong>Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ:</strong> "{{ query }}"
            {% if search_type %}
            | <strong>Ù†ÙˆØ¹ Ø¬Ø³ØªØ¬Ùˆ:</strong>
            {% if search_type == 'persons' %}ğŸ‘¥ Ø§ÙØ±Ø§Ø¯{% else %}ğŸ“„ Ø§Ø³Ù†Ø§Ø¯{% endif %}
            {% endif %}
        </div>
    </div>
</div>

<!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ -->
<div class="search-results">
    <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§ÙØ±Ø§Ø¯ -->
    {% if search_type == 'persons' or not search_type %}
    <div class="results-section" style="margin-bottom: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
            ğŸ‘¥ Ø§ÙØ±Ø§Ø¯ ÛŒØ§ÙØª Ø´Ø¯Ù‡ ({{ persons|length }})
        </h3>

        {% if persons %}
        <div class="persons-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px;">
            {% for person in persons %}
            <div class="person-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: 1px solid #e0e0e0; transition: all 0.3s;"
                 onmouseover="this.style.transform='translateY(-5px)'; this.style.boxShadow='0 5px 20px rgba(0,0,0,0.15)'"
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 10px rgba(0,0,0,0.1)'">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <div style="font-size: 24px; margin-left: 10px;">ğŸ‘¤</div>
                    <div>
                        <h4 style="color: #2c3e50; margin: 0;">{{ person.first_name }} {{ person.last_name }}</h4>
                        <p style="color: #7f8c8d; margin: 2px 0; font-size: 14px;">Ú©Ø¯ Ù…Ù„ÛŒ: {{ person.national_id }}</p>
                    </div>
                </div>

                {% if person.employee_id %}
                <p style="margin: 8px 0;"><strong>Ø´Ù…Ø§Ø±Ù‡ Ù¾Ø±Ø³Ù†Ù„ÛŒ:</strong> {{ person.employee_id }}</p>
                {% endif %}

                <p style="margin: 8px 0;"><strong>Ø´Ø±Ø­ Ù¾Ø±ÙˆÙ†Ø¯Ù‡:</strong>
                    <span style="color: #666;">{{ person.case_description|truncatewords:20 }}</span>
                </p>

                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <span style="color: #3498db; font-size: 14px;">
                        ğŸ“ {{ person.get_documents_count }} Ø³Ù†Ø¯
                    </span>

                    <div class="person-actions">
                        {% if user|has_perm:'person_detail' %}
                        <button class="btn btn-primary" onclick="location.href='{% url 'person_detail' person.id %}'"
                                style="padding: 8px 15px; font-size: 14px;">
                            ğŸ“‚ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ”</div>
            <h4 style="color: #7f8c8d; margin-bottom: 10px;">Ù‡ÛŒÚ† ÙØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
            <p style="color: #95a5a6;">Ù„Ø·ÙØ§Ù‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø§Ø³Ù†Ø§Ø¯ -->
    {% if search_type == 'documents' %}
    <div class="results-section" style="margin-bottom: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #27ae60;">
            ğŸ“„ Ø§Ø³Ù†Ø§Ø¯ ÛŒØ§ÙØª Ø´Ø¯Ù‡ ({{ documents|length }})
        </h3>

        {% if documents %}
        <div class="documents-list">
            {% for document in documents %}
            <div class="document-item"
                 style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e0e0e0; cursor: pointer; transition: all 0.3s;"
                 onclick="showDocumentContent({{ document.id }})"
                 onmouseover="this.style.background='#f8f9fa'; this.style.transform='translateX(-5px)'"
                 onmouseout="this.style.background='white'; this.style.transform='translateX(0)'">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="font-size: 20px; margin-left: 10px;">
                                {% if document.file_extension == 'pdf' %}ğŸ“„
                                {% elif document.file_extension in 'jpg,jpeg,png' %}ğŸ–¼ï¸
                                {% else %}ğŸ“{% endif %}
                            </div>
                            <h5 style="margin: 0; color: #2c3e50;">{{ document.file_name }}</h5>
                        </div>

                        <div style="display: grid; grid-template-columns: auto auto auto; gap: 15px; font-size: 14px;">
                            <div>
                                <strong>ğŸ‘¤ Ù…Ø§Ù„Ú©:</strong> {{ document.person.first_name }} {{ document.person.last_name }}
                            </div>
                            <div>
                                <strong>ğŸ“ Ù†ÙˆØ¹:</strong> {{ document.file_type|upper }}
                            </div>
                            <div>
                                <strong>ğŸ“… ØªØ§Ø±ÛŒØ®:</strong> {{ document.created_at|date:"Y/m/d" }}
                            </div>
                        </div>

                        {% if document.folder %}
                        <div style="margin-top: 8px;">
                            <strong>ğŸ“‚ Ù¾ÙˆØ´Ù‡:</strong> <span style="color: #666;">{{ document.folder.name }}</span>
                        </div>
                        {% endif %}

                        {% if document.description %}
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                            <strong>ğŸ“ Ø´Ø±Ø­:</strong>
                            <span style="color: #666;">{{ document.description|truncatewords:25 }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <div style="text-align: left; min-width: 120px;">
                        {% if document.ocr_processed %}
                        <span style="color: #27ae60; font-size: 13px; display: block; margin-bottom: 5px;">
                            âœ“ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡
                        </span>
                        {% if document.extraction_confidence %}
                        <span style="color: #7f8c8d; font-size: 12px;">
                            ğŸ¯ {{ document.extraction_confidence }}% Ø¯Ù‚Øª
                        </span>
                        {% endif %}
                        {% else %}
                        <span style="color: #e74c3c; font-size: 13px;">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: white; border-radius: 10px;">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ”</div>
            <h4 style="color: #7f8c8d; margin-bottom: 10px;">Ù‡ÛŒÚ† Ø³Ù†Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h4>
            <p style="color: #95a5a6;">Ù„Ø·ÙØ§Ù‹ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø®ÙˆØ¯ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯.</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Ù¾ÛŒØ§Ù… Ø¹Ø¯Ù… ÛŒØ§ÙØªÙ† Ù†ØªÛŒØ¬Ù‡ -->
    {% if not persons and not documents %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px;">
        <div style="font-size: 72px; margin-bottom: 20px;">ğŸ”</div>
        <h3 style="color: #2c3e50; margin-bottom: 15px;">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
        <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
            Ù‡ÛŒÚ† ÙØ±Ø¯ ÛŒØ§ Ø³Ù†Ø¯ÛŒ Ø¨Ø§ Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù…Ø§ ÛŒØ§ÙØª Ù†Ø´Ø¯.<br>
            Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
        </p>
        <div>
            <button class="btn btn-primary" onclick="location.href='{% url 'search_documents' %}'">
                ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            </button>
            {% if user|has_perm:'person_create' %}
            <button class="btn btn-success" onclick="location.href='{% url 'home' %}'">
                â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯
            </button>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù†Ø¯ -->
{% include 'ocr_app/modals.html' %}

<script>
    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù†Ø¯
    async function showDocumentContent(documentId) {
        try {
            const response = await fetch(`/document-content/${documentId}/`);
            const data = await response.json();

            // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„ Ø³Ù†Ø¯
            showDocumentModal(data);
        } catch (error) {
            console.error('Error loading document content:', error);
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù†Ø¯');
        }
    }
</script>
{% endblock %}