<!-- templates/ocr_app/person_management.html -->
{% extends 'ocr_app/base.html' %}

{% block page_title %}ูุฏุฑุช ุงูุฑุงุฏ ู ูพุฑููุฏูโูุง{% endblock %}

{% block content %}
<div class="header">
    <h1>ูุฏุฑุช ุงูุฑุงุฏ</h1>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <button class="btn btn-primary" onclick="showCreatePersonModal()">
            โ ุงูุฒูุฏู ูุฑุฏ ุฌุฏุฏ
        </button>

        <div style="display: flex; align-items: center;">
            <input type="text" id="searchInput" placeholder="ุฌุณุชุฌู ุจุฑ ุงุณุงุณ ูุงูุ ูุงู ุฎุงููุงุฏฺฏ ุง ฺฉุฏ ูู..."
                   style="padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; margin-left: 10px; width: 300px; font-size: 14px;">
            <button class="btn btn-success" onclick="searchPersons()">
                ๐ ุฌุณุชุฌู
            </button>
            <button class="btn" onclick="clearSearch()" style="background: #95a5a6; color: white; margin-left: 10px;">
                ูพุงฺฉ ฺฉุฑุฏู
            </button>
        </div>
    </div>
</div>

<!-- ุจุฎุด ุฌุณุชุฌู ู ูุชุงุฌ -->
<div id="searchSection">
    <!-- ูพุงู ุฎูุดุงูุฏฺฏู -->
    <div id="welcomeMessage" style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px; margin-bottom: 20px;">
        <div style="font-size: 72px; margin-bottom: 20px;">๐</div>
        <h2 style="color: #2c3e50; margin-bottom: 15px;">ุจู ุณุณุชู ูุฏุฑุช ุงุณูุงุฏ ุฎูุด ุขูุฏุฏ</h2>
        <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6;">
            ุจุฑุง ูุดุงูุฏู ุงูุฑุงุฏุ ูุทูุงู ุงุฒ ฺฉุงุฏุฑ ุฌุณุชุฌู ุจุงูุง ุงุณุชูุงุฏู ฺฉูุฏ.<br>
            ูโุชูุงูุฏ ุจุฑ ุงุณุงุณ ูุงูุ ูุงู ุฎุงููุงุฏฺฏ ุง ฺฉุฏ ูู ุฌุณุชุฌู ฺฉูุฏ.
        </p>
    </div>

    <!-- ูุชุงุฌ ุฌุณุชุฌู -->
    <div id="searchResults" style="display: none;">
        <h3 style="color: #2c3e50; margin-bottom: 20px;">ูุชุงุฌ ุฌุณุชุฌู</h3>
        <div class="persons-grid" id="personsGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            <!-- ูุชุงุฌ ุจุง JavaScript ูพุฑ ูโุดููุฏ -->
        </div>

        <div id="noResults" style="display: none; text-align: center; padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 15px;">๐</div>
            <h4 style="color: #7f8c8d; margin-bottom: 10px;">ูุชุฌูโุง ุงูุช ูุดุฏ</h4>
            <p style="color: #95a5a6;">ูุทูุงู ุนุจุงุฑุช ุฌุณุชุฌู ุฎูุฏ ุฑุง ุชุบุฑ ุฏูุฏ ุง ูุฑุฏ ุฌุฏุฏ ุงุถุงูู ฺฉูุฏ.</p>
        </div>
    </div>
</div>

<!-- Modal ุงุฌุงุฏ ูุฑุฏ ุฌุฏุฏ -->
<div id="createPersonModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background: white; width: 500px; margin: 100px auto; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
        <h3 style="color: #2c3e50; margin-bottom: 20px;">ุงูุฒูุฏู ูุฑุฏ ุฌุฏุฏ</h3>
        <form id="createPersonForm">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">ูุงู:</label>
                <input type="text" name="first_name" placeholder="ูุงู" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">ูุงู ุฎุงููุงุฏฺฏ:</label>
                <input type="text" name="last_name" placeholder="ูุงู ุฎุงููุงุฏฺฏ" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">ฺฉุฏ ูู:</label>
                <input type="text" name="national_id" placeholder="ฺฉุฏ ูู" required
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; color: #555;">ุดุฑุญ ูพุฑููุฏู:</label>
                <textarea name="case_description" placeholder="ุดุฑุญ ูพุฑููุฏู"
                          style="width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; resize: vertical;"></textarea>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary" style="flex: 1;">๐พ ุฐุฎุฑู</button>
                <button type="button" class="btn" onclick="hideCreatePersonModal()"
                        style="flex: 1; background: #95a5a6; color: white;">โ ูุบู</button>
            </div>
        </form>
    </div>
</div>

<script>
    // ุชูุงุจุน ูุฏุฑุช Modal
    function showCreatePersonModal() {
        document.getElementById('createPersonModal').style.display = 'block';
    }

    function hideCreatePersonModal() {
        document.getElementById('createPersonModal').style.display = 'none';
    }

    // ุฌุณุชุฌู ุงูุฑุงุฏ
    function searchPersons() {
        const query = document.getElementById('searchInput').value.trim();

        if (!query) {
            alert('ูุทูุงู ุนุจุงุฑุช ุฌุณุชุฌู ุฑุง ูุงุฑุฏ ฺฉูุฏ');
            return;
        }

        // ููุงุด loading
        document.getElementById('welcomeMessage').style.display = 'none';
        document.getElementById('searchResults').style.display = 'block';
        document.getElementById('personsGrid').innerHTML = '<div style="text-align: center; padding: 40px; grid-column: 1 / -1;"><p>ุฏุฑ ุญุงู ุฌุณุชุฌู...</p></div>';

        // ุฌุณุชุฌู AJAX
        fetch(`/search/?q=${encodeURIComponent(query)}&type=people`)
            .then(response => response.text())
            .then(html => {
                // ุงูุฌุง ุจุงุฏ HTML ุจุฑฺฏุดุช ุฑุง parse ฺฉูู ู ููุท ุจุฎุด ูุชุงุฌ ุฑุง ููุงุด ุฏูู
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;

                const results = tempDiv.querySelector('.persons-grid') || tempDiv.querySelector('#personsGrid');

                if (results && results.innerHTML.trim()) {
                    document.getElementById('personsGrid').innerHTML = results.innerHTML;
                    document.getElementById('noResults').style.display = 'none';
                } else {
                    document.getElementById('personsGrid').innerHTML = '';
                    document.getElementById('noResults').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('personsGrid').innerHTML = '';
                document.getElementById('noResults').style.display = 'block';
            });
    }

    // ุฌุณุชุฌู ุจุง Enter
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchPersons();
        }
    });

    // ูพุงฺฉ ฺฉุฑุฏู ุฌุณุชุฌู
    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('welcomeMessage').style.display = 'block';
        document.getElementById('searchResults').style.display = 'none';
    }

    // ูุฏุฑุช ูุฑู ุงุฌุงุฏ ูุฑุฏ
    document.getElementById('createPersonForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/create-person/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('ูุฑุฏ ุจุง ููููุช ุฐุฎุฑู ุดุฏ');
                hideCreatePersonModal();
                // ุงฺฏุฑ ุฏุฑ ุญุงู ุฌุณุชุฌู ูุณุชูุ ุฌุณุชุฌู ุฑุง ูุฌุฏุฏ ุงูุฌุงู ุฏูู
                if (document.getElementById('searchResults').style.display === 'block') {
                    searchPersons();
                }
            } else {
                alert('ุฎุทุง: ' + result.error);
            }
        } catch (error) {
            alert('ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ');
            console.error('Error:', error);
        }
    };

    // ุจุณุชู Modal ุจุง ฺฉูฺฉ ุฎุงุฑุฌ ุงุฒ ุขู
    document.getElementById('createPersonModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideCreatePersonModal();
        }
    });

    // ุงฺฏุฑ ุฏุฑ URL ูพุงุฑุงูุชุฑ ุฌุณุชุฌู ูุฌูุฏ ุฏุงุฑุฏุ ุฌุณุชุฌู ุฑุง ุงูุฌุงู ุจุฏู
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('q');
    if (searchQuery) {
        document.getElementById('searchInput').value = searchQuery;
        setTimeout(() => searchPersons(), 100);
    }
</script>
{% endblock %}