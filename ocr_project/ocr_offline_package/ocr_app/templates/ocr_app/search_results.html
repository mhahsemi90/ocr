<!-- templates/ocr_app/search_results.html -->
{% extends 'ocr_app/base.html' %}

{% block page_title %}Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ{% endblock %}

{% block content %}
<div class="header">
    <h1>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ</h1>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
        <button class="btn btn-primary" onclick="location.href='{% url 'search_documents' %}'">
            ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¬Ø¯ÛŒØ¯
        </button>

        <div style="color: #7f8c8d;">
            <strong>Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ:</strong> "{{ query }}"
        </div>
    </div>
</div>

<!-- Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ -->
<div class="search-results">
    <!-- Ù†ØªØ§ÛŒØ¬ Ø§ÙØ±Ø§Ø¯ -->
    {% if persons %}
    <div class="results-section" style="margin-bottom: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #3498db;">
            ğŸ‘¥ Ø§ÙØ±Ø§Ø¯ ÛŒØ§ÙØª Ø´Ø¯Ù‡ ({{ persons|length }})
        </h3>

        <div class="persons-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
            {% for person in persons %}
            <div class="person-card" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #e0e0e0;">
                <h4 style="color: #2c3e50; margin-bottom: 10px;">{{ person.first_name }} {{ person.last_name }}</h4>
                <p style="margin: 5px 0;"><strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> {{ person.national_id }}</p>
                <p style="margin: 5px 0;"><strong>Ø´Ø±Ø­ Ù¾Ø±ÙˆÙ†Ø¯Ù‡:</strong> {{ person.case_description|truncatewords:15 }}</p>
                <p style="margin: 5px 0;"><strong>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³Ù†Ø§Ø¯:</strong> {{ person.get_documents_count }}</p>

                <div class="person-actions" style="margin-top: 15px;">
                    <button class="btn btn-primary" onclick="location.href='{% url 'person_detail' person.id %}'">
                        ğŸ“‚ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù¾Ø±ÙˆÙ†Ø¯Ù‡
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Ù†ØªØ§ÛŒØ¬ Ø§Ø³Ù†Ø§Ø¯ -->
    {% if documents %}
    <div class="results-section" style="margin-bottom: 30px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #27ae60;">
            ğŸ“„ Ø§Ø³Ù†Ø§Ø¯ ÛŒØ§ÙØª Ø´Ø¯Ù‡ ({{ documents|length }})
        </h3>

        <div class="documents-list">
            {% for document in documents %}
            <div class="document-item"
                 style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e0e0e0; cursor: pointer;"
                 onclick="showDocumentContent({{ document.id }})"
                 onmouseover="this.style.background='#f8f9fa'"
                 onmouseout="this.style.background='white'">
                <div style="display: flex; justify-content: between; align-items: center;">
                    <div style="flex: 1;">
                        <h5 style="margin: 0 0 5px 0; color: #2c3e50;">{{ document.file_name }}</h5>
                        <p style="margin: 0; color: #7f8c8d; font-size: 14px;">
                            <strong>Ù…Ø§Ù„Ú©:</strong> {{ document.person.first_name }} {{ document.person.last_name }}
                            {% if document.folder %}
                            | <strong>Ù¾ÙˆØ´Ù‡:</strong> {{ document.folder.name }}
                            {% endif %}
                        </p>
                        {% if document.description %}
                        <p style="margin: 5px 0 0 0; color: #666; font-size: 13px;">
                            {{ document.description|truncatewords:20 }}
                        </p>
                        {% endif %}
                    </div>
                    <div style="text-align: left;">
                        {% if document.ocr_processed %}
                        <span style="color: #27ae60; font-size: 12px;">âœ“ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡</span>
                        {% else %}
                        <span style="color: #e74c3c; font-size: 12px;">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Ù¾ÛŒØ§Ù… Ø¹Ø¯Ù… ÛŒØ§ÙØªÙ† Ù†ØªÛŒØ¬Ù‡ -->
    {% if not persons and not documents %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px;">
        <div style="font-size: 72px; margin-bottom: 20px;">ğŸ”</div>
        <h3 style="color: #2c3e50; margin-bottom: 15px;">Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</h3>
        <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
            Ù‡ÛŒÚ† ÙØ±Ø¯ ÛŒØ§ Ø³Ù†Ø¯ÛŒ Ø¨Ø§ Ø¹Ø¨Ø§Ø±Øª "{{ query }}" ÛŒØ§ÙØª Ù†Ø´Ø¯.<br>
            Ù„Ø·ÙØ§Ù‹ Ø¹Ø¨Ø§Ø±Øª Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ ÛŒØ§ Ø§Ø² Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
        </p>
        <div>
            <button class="btn btn-primary" onclick="location.href='{% url 'search_documents' %}'">
                ğŸ” Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            </button>
            <button class="btn btn-success" onclick="location.href='{% url 'home' %}'">
                â• Ø§ÙØ²ÙˆØ¯Ù† ÙØ±Ø¯ Ø¬Ø¯ÛŒØ¯
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ù†Ø¯ -->
<div id="documentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div style="background: white; width: 80%; max-width: 800px; margin: 50px auto; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); max-height: 80vh; overflow-y: auto;">
        <h3 id="documentTitle" style="color: #2c3e50; margin-bottom: 20px;"></h3>
        <div id="documentContent"></div>
        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="hideDocumentModal()"
                    style="background: #95a5a6; color: white; padding: 10px 20px;">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>
</div>

<script>
    async function showDocumentContent(documentId) {
        const response = await fetch(`/document-content/${documentId}/`);
        const data = await response.json();

        document.getElementById('documentTitle').textContent = data.file_name;

        let content = `
            <div style="margin-bottom: 20px;">
                <p><strong>ğŸ‘¤ Ù…Ø§Ù„Ú©:</strong> ${data.person_name}</p>
                ${data.description ? `<p><strong>ğŸ“ Ø´Ø±Ø­:</strong> ${data.description}</p>` : ''}
            </div>
        `;

        if (data.processed) {
            content += `
                <div style="margin-bottom: 15px;">
                    <p><strong>ğŸ“Š Ø¯Ù‚Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬:</strong> <span style="color: #27ae60;">${(data.confidence * 100).toFixed(2)}%</span></p>
                </div>
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; border: 1px solid #e0e0e0;">
                    <h4 style="color: #2c3e50; margin-bottom: 15px;">Ù…ØªÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡:</h4>
                    <div style="white-space: pre-wrap; line-height: 1.6; text-align: right; direction: rtl;">
                        ${data.extracted_text || 'Ù…ØªÙ†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯'}
                    </div>
                </div>
            `;
        } else {
            content += `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                    <h4>Ø§ÛŒÙ† Ø³Ù†Ø¯ Ù‡Ù†ÙˆØ² Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</h4>
                    <p>Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¯ÛŒÚ¯Ø± Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.</p>
                </div>
            `;
        }

        document.getElementById('documentContent').innerHTML = content;
        document.getElementById('documentModal').style.display = 'block';
    }

    function hideDocumentModal() {
        document.getElementById('documentModal').style.display = 'none';
    }
</script>
{% endblock %}