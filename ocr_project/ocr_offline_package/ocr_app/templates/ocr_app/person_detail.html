<!-- templates/ocr_app/person_detail.html -->
{% extends 'ocr_app/base.html' %}

{% block content %}
<div class="header">
    <h1>{{ person.first_name }} {{ person.last_name }}</h1>
    <p><strong>کد ملی:</strong> {{ person.national_id }}</p>
    <p><strong>شرح پرونده:</strong> {{ person.case_description }}</p>

    <div class="actions" style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="showCreateFolderModal()">
            📁 ایجاد پوشه جدید
        </button>
        <button class="btn btn-success" onclick="showUploadModal()">
            📤 آپلود فایل جدید
        </button>
    </div>
</div>

<!-- نوار آدرس (Breadcrumb) -->
<div class="breadcrumb" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
    <div id="breadcrumbPath" style="display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
        <span style="color: #3498db; cursor: pointer;" onclick="navigateToFolder(null)">📂 ریشه</span>
        <span id="breadcrumbSeparator" style="display: none;">/</span>
        <span id="currentFolderPath"></span>
    </div>
</div>

<!-- بخش فایلها و پوشه‌ها (شبیه Windows Explorer) -->
<div class="file-explorer" style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; min-height: 400px;">
    <!-- هدر جدول -->
    <div class="explorer-header" style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; border-radius: 10px 10px 0 0; font-weight: bold; color: #2c3e50;">
        <div></div>
        <div>نام</div>
        <div>نوع</div>
        <div>وضعیت</div>
    </div>

    <!-- محتوای فایل‌ها و پوشه‌ها -->
    <div id="explorerContent" style="padding: 10px;">
        <!-- محتوا با JavaScript پر می‌شود -->
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
            <div style="font-size: 48px; margin-bottom: 15px;">📁</div>
            <p>در حال بارگذاری...</p>
        </div>
    </div>
</div>

<!-- Modal‌ها -->
{% include 'ocr_app/modals.html' %}

<script>
    let currentFolderId = null;
    let folderStack = []; // برای مدیریت تاریخچه پوشه‌ها
    let allFolders = []; // برای ذخیره تمام پوشه‌ها

    // بارگذاری اولیه محتوا و پوشه‌ها
    document.addEventListener('DOMContentLoaded', function() {
        loadFolderContent(null);
        loadAllFolders();
    });

    // بارگذاری تمام پوشه‌های فرد
    async function loadAllFolders() {
        try {
            const response = await fetch(`/get-person-folders/{{ person.id }}/`);
            const data = await response.json();
            allFolders = data.folders;
            updateFolderDropdowns();
        } catch (error) {
            console.error('Error loading folders:', error);
        }
    }

    // به‌روزرسانی dropdown پوشه‌ها در Modal‌ها
    function updateFolderDropdowns() {
        const parentFolderSelect = document.querySelector('#createFolderModal select[name="parent_folder_id"]');
        const uploadFolderSelect = document.querySelector('#uploadModal select[name="folder_id"]');

        function buildFolderOptions(folders, level = 0) {
            let options = '';
            const indent = '─'.repeat(level * 2);

            folders.forEach(folder => {
                const displayName = level === 0 ? folder.name : `${indent} ${folder.name}`;
                options += `<option value="${folder.id}">${displayName}</option>`;

                // اضافه کردن زیرپوشه‌ها
                if (folder.subfolders && folder.subfolders.length > 0) {
                    options += buildFolderOptions(folder.subfolders, level + 1);
                }
            });

            return options;
        }

        const folderOptions = buildFolderOptions(allFolders);

        if (parentFolderSelect) {
            parentFolderSelect.innerHTML = '<option value="">ریشه (بدون والد)</option>' + folderOptions;

            // تنظیم پوشه والد بر اساس مکان فعلی
            if (currentFolderId) {
                parentFolderSelect.value = currentFolderId;
            }
        }

        if (uploadFolderSelect) {
            uploadFolderSelect.innerHTML = '<option value="">ریشه (ذخیره مستقیم)</option>' + folderOptions;

            // تنظیم پوشه مقصد بر اساس مکان فعلی
            if (currentFolderId) {
                uploadFolderSelect.value = currentFolderId;
            }
        }
    }

    // بارگذاری محتوای پوشه
    async function loadFolderContent(folderId, folderName = null) {
        const explorerContent = document.getElementById('explorerContent');

        // نمایش loading
        explorerContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                <div style="font-size: 48px; margin-bottom: 15px;">⏳</div>
                <p>در حال بارگذاری...</p>
            </div>
        `;

        try {
            let url = '';
            if (folderId) {
                url = `/get-folder-contents/${folderId}/`;
            } else {
                // اگر folderId null باشد، محتوای ریشه را بارگیری کن
                url = `/get-root-contents/{{ person.id }}/`;
            }

            const response = await fetch(url);
            const data = await response.json();

            // به‌روزرسانی نوار آدرس
            updateBreadcrumb(folderId, folderName);

            // نمایش محتوا
            displayFolderContent(data, folderId);

            // ذخیره پوشه فعلی و به‌روزرسانی dropdownها
            currentFolderId = folderId;
            updateFolderDropdowns();

        } catch (error) {
            console.error('Error loading folder content:', error);
            explorerContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <div style="font-size: 48px; margin-bottom: 15px;">❌</div>
                    <p>خطا در بارگذاری محتوا</p>
                </div>
            `;
        }
    }

    // نمایش محتوای پوشه
    function displayFolderContent(data, folderId) {
        const explorerContent = document.getElementById('explorerContent');
        let html = '';

        // نمایش پوشه‌ها
        data.subfolders.forEach(folder => {
            html += `
                <div class="folder-item"
                     onclick="navigateToFolder(${folder.id}, '${folder.name.replace(/'/g, "\\'")}')"
                     style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.background='#f8f9fa'"
                     onmouseout="this.style.background='white'">
                    <div>📁</div>
                    <div style="font-weight: 500; color: #2c3e50;">${folder.name}</div>
                    <div style="color: #7f8c8d;">پوشه</div>
                    <div style="color: #3498db;">-</div>
                </div>
            `;
        });

        // نمایش فایل‌ها
        data.documents.forEach(doc => {
            const status = doc.processed ?
                '<span style="color: #27ae60;">✓ پردازش شده</span>' :
                '<span style="color: #e74c3c;">⏳ در انتظار</span>';

            html += `
                <div class="file-item"
                     onclick="showDocumentContent(${doc.id})"
                     style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.background='#f8f9fa'"
                     onmouseout="this.style.background='white'">
                    <div>📄</div>
                    <div style="font-weight: 500; color: #2c3e50;">${doc.name}</div>
                    <div style="color: #7f8c8d;">فایل</div>
                    <div>${status}</div>
                </div>
            `;
        });

        // اگر پوشه خالی است
        if (data.subfolders.length === 0 && data.documents.length === 0) {
            html = `
                <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 72px; margin-bottom: 20px;">📭</div>
                    <h4 style="margin-bottom: 10px;">این پوشه خالی است</h4>
                    <p>می‌توانید فایل جدیدی آپلود کنید یا پوشه جدیدی ایجاد کنید.</p>
                </div>
            `;
        }

        explorerContent.innerHTML = html;
    }

    // به‌روزرسانی نوار آدرس
    function updateBreadcrumb(folderId, folderName) {
        const breadcrumbPath = document.getElementById('breadcrumbPath');

        if (folderId) {
            // اضافه کردن به تاریخچه
            folderStack.push({ id: folderId, name: folderName });

            // ساخت نوار آدرس
            let breadcrumbHTML = `<span style="color: #3498db; cursor: pointer;" onclick="navigateToFolder(null)">📂 ریشه</span>`;

            folderStack.forEach((folder, index) => {
                breadcrumbHTML += ` <span style="color: #7f8c8d;">/</span> `;
                if (index === folderStack.length - 1) {
                    // پوشه فعلی - غیرقابل کلیک
                    breadcrumbHTML += `<span style="color: #2c3e50;">📁 ${folder.name}</span>`;
                } else {
                    // پوشه‌های قبلی - قابل کلیک
                    breadcrumbHTML += `<span style="color: #3498db; cursor: pointer;" onclick="navigateToStack(${index})">📁 ${folder.name}</span>`;
                }
            });

            breadcrumbPath.innerHTML = breadcrumbHTML;
        } else {
            // بازگشت به ریشه
            folderStack = [];
            breadcrumbPath.innerHTML = `<span style="color: #2c3e50;">📂 ریشه</span>`;
        }
    }

    // پیمایش به پوشه خاص
    function navigateToFolder(folderId, folderName = null) {
        loadFolderContent(folderId, folderName);
    }

    // پیمایش در تاریخچه (برای نوار آدرس)
    function navigateToStack(index) {
        // حذف پوشه‌های بعد از index
        folderStack = folderStack.slice(0, index + 1);

        const targetFolder = folderStack[index];
        if (targetFolder) {
            loadFolderContent(targetFolder.id, targetFolder.name);
        } else {
            loadFolderContent(null);
        }
    }

    // توابع مدیریت Modal‌ها
    function showCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'block';
        // تنظیم پوشه والد در فرم بر اساس مکان فعلی
        const parentFolderSelect = document.querySelector('#createFolderModal select[name="parent_folder_id"]');
        if (parentFolderSelect && currentFolderId) {
            parentFolderSelect.value = currentFolderId;
        }
    }

    function hideCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'none';
    }

    function showUploadModal() {
        document.getElementById('uploadModal').style.display = 'block';
        // تنظیم پوشه مقصد در فرم بر اساس مکان فعلی
        const folderSelect = document.querySelector('#uploadModal select[name="folder_id"]');
        if (folderSelect && currentFolderId) {
            folderSelect.value = currentFolderId;
        }
    }

    function hideUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
    }

    function hideDocumentModal() {
        document.getElementById('documentModal').style.display = 'none';
    }

    // مدیریت فرم‌ها
    document.getElementById('createFolderForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/create-folder/{{ person.id }}/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('پوشه با موفقیت ایجاد شد');
                hideCreateFolderModal();
                // رفرش محتوای فعلی و لیست پوشه‌ها
                loadFolderContent(currentFolderId);
                loadAllFolders();
            } else {
                alert('خطا: ' + result.error);
            }
        } catch (error) {
            alert('خطا در ارتباط با سرور');
        }
    };

    document.getElementById('uploadForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        try {
            const response = await fetch('/upload-documents/{{ person.id }}/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const result = await response.json();
            if (result.success) {
                alert(`تعداد ${result.documents.length} فایل به صف اسکن اضافه شد`);
                hideUploadModal();
                // رفرش محتوای فعلی
                loadFolderContent(currentFolderId);
            } else {
                alert('خطا در آپلود فایل‌ها');
            }
        } catch (error) {
            alert('خطا در ارتباط با سرور');
        }
    };

    // بستن Modal با کلیک خارج از آن
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}