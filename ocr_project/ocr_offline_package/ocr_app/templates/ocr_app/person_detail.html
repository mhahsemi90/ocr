<!-- templates/ocr_app/person_detail.html -->
{% extends 'ocr_app/base.html' %}

{% block content %}
<div class="header">
    <h1>{{ person.first_name }} {{ person.last_name }}</h1>
    <p><strong>Ú©Ø¯ Ù…Ù„ÛŒ:</strong> {{ person.national_id }}</p>
    <p><strong>Ø´Ø±Ø­ Ù¾Ø±ÙˆÙ†Ø¯Ù‡:</strong> {{ person.case_description }}</p>

    <div class="actions" style="margin-top: 20px;">
        <button class="btn btn-primary" onclick="showCreateFolderModal()">
            ğŸ“ Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ Ø¬Ø¯ÛŒØ¯
        </button>
        <button class="btn btn-success" onclick="showUploadModal()">
            ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯
        </button>
    </div>
</div>

<!-- Ù†ÙˆØ§Ø± Ø¢Ø¯Ø±Ø³ (Breadcrumb) -->
<div class="breadcrumb" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
    <div id="breadcrumbPath" style="display: flex; align-items: center; flex-wrap: wrap; gap: 5px;">
        <span style="color: #3498db; cursor: pointer;" onclick="navigateToFolder(null)">ğŸ“‚ Ø±ÛŒØ´Ù‡</span>
        <span id="breadcrumbSeparator" style="display: none;">/</span>
        <span id="currentFolderPath"></span>
    </div>
</div>

<!-- Ø¨Ø®Ø´ ÙØ§ÛŒÙ„Ù‡Ø§ Ùˆ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ (Ø´Ø¨ÛŒÙ‡ Windows Explorer) -->
<div class="file-explorer" style="background: white; border-radius: 10px; border: 1px solid #e0e0e0; min-height: 400px;">
    <!-- Ù‡Ø¯Ø± Ø¬Ø¯ÙˆÙ„ -->
    <div class="explorer-header" style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 15px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; border-radius: 10px 10px 0 0; font-weight: bold; color: #2c3e50;">
        <div></div>
        <div>Ù†Ø§Ù…</div>
        <div>Ù†ÙˆØ¹</div>
        <div>ÙˆØ¶Ø¹ÛŒØª</div>
    </div>

    <!-- Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ -->
    <div id="explorerContent" style="padding: 10px;">
        <!-- Ù…Ø­ØªÙˆØ§ Ø¨Ø§ JavaScript Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“</div>
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
        </div>
    </div>
</div>

<!-- Modalâ€ŒÙ‡Ø§ -->
{% include 'ocr_app/modals.html' %}

<script>
    let currentFolderId = null;
    let folderStack = []; // Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
    let allFolders = []; // Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ ØªÙ…Ø§Ù… Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù…Ø­ØªÙˆØ§ Ùˆ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
    document.addEventListener('DOMContentLoaded', function() {
        loadFolderContent(null);
        loadAllFolders();
    });

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªÙ…Ø§Ù… Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ø¯
    async function loadAllFolders() {
        try {
            const response = await fetch(`/get-person-folders/{{ person.id }}/`);
            const data = await response.json();
            allFolders = data.folders;
            updateFolderDropdowns();
        } catch (error) {
            console.error('Error loading folders:', error);
        }
    }

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ dropdown Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Modalâ€ŒÙ‡Ø§
    function updateFolderDropdowns() {
        const parentFolderSelect = document.querySelector('#createFolderModal select[name="parent_folder_id"]');
        const uploadFolderSelect = document.querySelector('#uploadModal select[name="folder_id"]');

        function buildFolderOptions(folders, level = 0) {
            let options = '';
            const indent = 'â”€'.repeat(level * 2);

            folders.forEach(folder => {
                const displayName = level === 0 ? folder.name : `${indent} ${folder.name}`;
                options += `<option value="${folder.id}">${displayName}</option>`;

                // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø²ÛŒØ±Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
                if (folder.subfolders && folder.subfolders.length > 0) {
                    options += buildFolderOptions(folder.subfolders, level + 1);
                }
            });

            return options;
        }

        const folderOptions = buildFolderOptions(allFolders);

        if (parentFolderSelect) {
            parentFolderSelect.innerHTML = '<option value="">Ø±ÛŒØ´Ù‡ (Ø¨Ø¯ÙˆÙ† ÙˆØ§Ù„Ø¯)</option>' + folderOptions;

            // ØªÙ†Ø¸ÛŒÙ… Ù¾ÙˆØ´Ù‡ ÙˆØ§Ù„Ø¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ
            if (currentFolderId) {
                parentFolderSelect.value = currentFolderId;
            }
        }

        if (uploadFolderSelect) {
            uploadFolderSelect.innerHTML = '<option value="">Ø±ÛŒØ´Ù‡ (Ø°Ø®ÛŒØ±Ù‡ Ù…Ø³ØªÙ‚ÛŒÙ…)</option>' + folderOptions;

            // ØªÙ†Ø¸ÛŒÙ… Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ
            if (currentFolderId) {
                uploadFolderSelect.value = currentFolderId;
            }
        }
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÙˆØ´Ù‡
    async function loadFolderContent(folderId, folderName = null) {
        const explorerContent = document.getElementById('explorerContent');

        // Ù†Ù…Ø§ÛŒØ´ loading
        explorerContent.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</p>
            </div>
        `;

        try {
            let url = '';
            if (folderId) {
                url = `/get-folder-contents/${folderId}/`;
            } else {
                // Ø§Ú¯Ø± folderId null Ø¨Ø§Ø´Ø¯ØŒ Ù…Ø­ØªÙˆØ§ÛŒ Ø±ÛŒØ´Ù‡ Ø±Ø§ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ú©Ù†
                url = `/get-root-contents/{{ person.id }}/`;
            }

            const response = await fetch(url);
            const data = await response.json();

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ø¢Ø¯Ø±Ø³
            updateBreadcrumb(folderId, folderName);

            // Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§
            displayFolderContent(data, folderId);

            // Ø°Ø®ÛŒØ±Ù‡ Ù¾ÙˆØ´Ù‡ ÙØ¹Ù„ÛŒ Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ dropdownÙ‡Ø§
            currentFolderId = folderId;
            updateFolderDropdowns();

        } catch (error) {
            console.error('Error loading folder content:', error);
            explorerContent.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e74c3c;">
                    <div style="font-size: 48px; margin-bottom: 15px;">âŒ</div>
                    <p>Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø­ØªÙˆØ§</p>
                </div>
            `;
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾ÙˆØ´Ù‡
    function displayFolderContent(data, folderId) {
        const explorerContent = document.getElementById('explorerContent');
        let html = '';

        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
        data.subfolders.forEach(folder => {
            html += `
                <div class="folder-item"
                     onclick="navigateToFolder(${folder.id}, '${folder.name.replace(/'/g, "\\'")}')"
                     style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.background='#f8f9fa'"
                     onmouseout="this.style.background='white'">
                    <div>ğŸ“</div>
                    <div style="font-weight: 500; color: #2c3e50;">${folder.name}</div>
                    <div style="color: #7f8c8d;">Ù¾ÙˆØ´Ù‡</div>
                    <div style="color: #3498db;">-</div>
                </div>
            `;
        });

        // Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        data.documents.forEach(doc => {
            const status = doc.processed ?
                '<span style="color: #27ae60;">âœ“ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡</span>' :
                '<span style="color: #e74c3c;">â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±</span>';

            html += `
                <div class="file-item"
                     onclick="showDocumentContent(${doc.id})"
                     style="display: grid; grid-template-columns: 40px 1fr 150px 120px; gap: 15px; padding: 12px 20px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s;"
                     onmouseover="this.style.background='#f8f9fa'"
                     onmouseout="this.style.background='white'">
                    <div>ğŸ“„</div>
                    <div style="font-weight: 500; color: #2c3e50;">${doc.name}</div>
                    <div style="color: #7f8c8d;">ÙØ§ÛŒÙ„</div>
                    <div>${status}</div>
                </div>
            `;
        });

        // Ø§Ú¯Ø± Ù¾ÙˆØ´Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª
        if (data.subfolders.length === 0 && data.documents.length === 0) {
            html = `
                <div style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                    <div style="font-size: 72px; margin-bottom: 20px;">ğŸ“­</div>
                    <h4 style="margin-bottom: 10px;">Ø§ÛŒÙ† Ù¾ÙˆØ´Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</h4>
                    <p>Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ÙØ§ÛŒÙ„ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù¾ÙˆØ´Ù‡ Ø¬Ø¯ÛŒØ¯ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯.</p>
                </div>
            `;
        }

        explorerContent.innerHTML = html;
    }

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†ÙˆØ§Ø± Ø¢Ø¯Ø±Ø³
    function updateBreadcrumb(folderId, folderName) {
        const breadcrumbPath = document.getElementById('breadcrumbPath');

        if (folderId) {
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ ØªØ§Ø±ÛŒØ®Ú†Ù‡
            folderStack.push({ id: folderId, name: folderName });

            // Ø³Ø§Ø®Øª Ù†ÙˆØ§Ø± Ø¢Ø¯Ø±Ø³
            let breadcrumbHTML = `<span style="color: #3498db; cursor: pointer;" onclick="navigateToFolder(null)">ğŸ“‚ Ø±ÛŒØ´Ù‡</span>`;

            folderStack.forEach((folder, index) => {
                breadcrumbHTML += ` <span style="color: #7f8c8d;">/</span> `;
                if (index === folderStack.length - 1) {
                    // Ù¾ÙˆØ´Ù‡ ÙØ¹Ù„ÛŒ - ØºÛŒØ±Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©
                    breadcrumbHTML += `<span style="color: #2c3e50;">ğŸ“ ${folder.name}</span>`;
                } else {
                    // Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ - Ù‚Ø§Ø¨Ù„ Ú©Ù„ÛŒÚ©
                    breadcrumbHTML += `<span style="color: #3498db; cursor: pointer;" onclick="navigateToStack(${index})">ğŸ“ ${folder.name}</span>`;
                }
            });

            breadcrumbPath.innerHTML = breadcrumbHTML;
        } else {
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø±ÛŒØ´Ù‡
            folderStack = [];
            breadcrumbPath.innerHTML = `<span style="color: #2c3e50;">ğŸ“‚ Ø±ÛŒØ´Ù‡</span>`;
        }
    }

    // Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ Ø®Ø§Øµ
    function navigateToFolder(folderId, folderName = null) {
        loadFolderContent(folderId, folderName);
    }

    // Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ (Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± Ø¢Ø¯Ø±Ø³)
    function navigateToStack(index) {
        // Ø­Ø°Ù Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² index
        folderStack = folderStack.slice(0, index + 1);

        const targetFolder = folderStack[index];
        if (targetFolder) {
            loadFolderContent(targetFolder.id, targetFolder.name);
        } else {
            loadFolderContent(null);
        }
    }

    // ØªÙˆØ§Ø¨Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Modalâ€ŒÙ‡Ø§
    function showCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'block';
        // ØªÙ†Ø¸ÛŒÙ… Ù¾ÙˆØ´Ù‡ ÙˆØ§Ù„Ø¯ Ø¯Ø± ÙØ±Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ
        const parentFolderSelect = document.querySelector('#createFolderModal select[name="parent_folder_id"]');
        if (parentFolderSelect && currentFolderId) {
            parentFolderSelect.value = currentFolderId;
        }
    }

    function hideCreateFolderModal() {
        document.getElementById('createFolderModal').style.display = 'none';
    }

    function showUploadModal() {
        document.getElementById('uploadModal').style.display = 'block';
        // ØªÙ†Ø¸ÛŒÙ… Ù¾ÙˆØ´Ù‡ Ù…Ù‚ØµØ¯ Ø¯Ø± ÙØ±Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ú©Ø§Ù† ÙØ¹Ù„ÛŒ
        const folderSelect = document.querySelector('#uploadModal select[name="folder_id"]');
        if (folderSelect && currentFolderId) {
            folderSelect.value = currentFolderId;
        }
    }

    function hideUploadModal() {
        document.getElementById('uploadModal').style.display = 'none';
    }

    function hideDocumentModal() {
        document.getElementById('documentModal').style.display = 'none';
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª ÙØ±Ù…â€ŒÙ‡Ø§
    document.getElementById('createFolderForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/create-folder/{{ person.id }}/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                alert('Ù¾ÙˆØ´Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
                hideCreateFolderModal();
                // Ø±ÙØ±Ø´ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ Ùˆ Ù„ÛŒØ³Øª Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
                loadFolderContent(currentFolderId);
                loadAllFolders();
            } else {
                alert('Ø®Ø·Ø§: ' + result.error);
            }
        } catch (error) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        }
    };

    document.getElementById('uploadForm').onsubmit = async function(e) {
        e.preventDefault();
        const formData = new FormData(this);

        try {
            const response = await fetch('/upload-documents/{{ person.id }}/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });

            const result = await response.json();
            if (result.success) {
                alert(`ØªØ¹Ø¯Ø§Ø¯ ${result.documents.length} ÙØ§ÛŒÙ„ Ø¨Ù‡ ØµÙ Ø§Ø³Ú©Ù† Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
                hideUploadModal();
                // Ø±ÙØ±Ø´ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ¹Ù„ÛŒ
                loadFolderContent(currentFolderId);
            } else {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§');
            }
        } catch (error) {
            alert('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±');
        }
    };

    // Ø¨Ø³ØªÙ† Modal Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¢Ù†
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                this.style.display = 'none';
            }
        });
    });
</script>
{% endblock %}